// js/app.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ù…Ø­Ø¯Ø«
import { db, collection, getDocs, deleteDoc, doc } from './firebase-config.js';

let allApps = [];
let currentFilter = 'all';

// Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
const sampleApps = [
    {
        id: '1',
        name: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ',
        description: 'ØªØ·Ø¨ÙŠÙ‚ Ø±Ø§Ø¦Ø¹ Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø¹Ø§Ø¦Ù„Ø©',
        version: '1.0.0',
        size: '25',
        category: 'social',
        downloadURL: 'https://example.com/app1.zip',
        rating: 4.5,
        downloads: 1500,
        featured: true
    },
    {
        id: '2',
        name: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨',
        description: 'Ø£Ù„Ø¹Ø§Ø¨ Ù…Ø³Ù„ÙŠØ© ÙˆÙ…Ø«ÙŠØ±Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹',
        version: '2.1.0',
        size: '45',
        category: 'games',
        downloadURL: 'https://example.com/app2.zip',
        rating: 4.2,
        downloads: 2300,
        trending: true
    },
    {
        id: '3',
        name: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©',
        description: 'Ø²ÙˆØ¯ Ø¥Ù†ØªØ§Ø¬ÙŠØªÙƒ Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù…ÙŠØ²',
        version: '1.5.0',
        size: '30',
        category: 'productivity',
        downloadURL: 'https://example.com/app3.zip',
        rating: 4.8,
        downloads: 1800,
        featured: true
    },
    {
        id: '4',
        name: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ÙÙŠÙ‡',
        description: 'Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø£ÙØ¶Ù„ Ù…Ø­ØªÙˆÙ‰ ØªØ±ÙÙŠÙ‡ÙŠ',
        version: '3.0.1',
        size: '35',
        category: 'entertainment',
        downloadURL: 'https://example.com/app4.zip',
        rating: 4.3,
        downloads: 1200,
        trending: true
    },
    {
        id: '5',
        name: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ…',
        description: 'ØªØ¹Ù„Ù… Ù…Ù‡Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©',
        version: '2.0.0',
        size: '28',
        category: 'education',
        downloadURL: 'https://example.com/app5.zip',
        rating: 4.6,
        downloads: 900
    },
    {
        id: '6',
        name: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø¯ÙˆØ§Øª',
        description: 'Ø£Ø¯ÙˆØ§Øª Ù…ÙÙŠØ¯Ø© Ù„Ø­ÙŠØ§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',
        version: '1.2.0',
        size: '22',
        category: 'utility',
        downloadURL: 'https://example.com/app6.zip',
        rating: 4.1,
        downloads: 750
    }
];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù† Firebase
async function loadApps() {
    try {
        console.log("Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...");
        
        const appsContainer = document.getElementById('apps-list');
        const featuredContainer = document.getElementById('featured-apps');
        const trendingContainer = document.getElementById('trending-apps');
        
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if (appsContainer) appsContainer.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª...</p></div>';
        if (featuredContainer) featuredContainer.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©...</p></div>';
        if (trendingContainer) trendingContainer.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©...</p></div>';

        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù† Firebase
        const querySnapshot = await getDocs(collection(db, "apps"));
        allApps = [];
        
        if (!querySnapshot.empty) {
            querySnapshot.forEach((doc) => {
                allApps.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù† Firebase:", allApps.length);
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
            allApps = sampleApps;
            console.log("ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©:", allApps.length);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        displayApps(allApps);
        displayFeaturedApps();
        displayTrendingApps();
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª:", error);
        
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        allApps = sampleApps;
        displayApps(allApps);
        displayFeaturedApps();
        displayTrendingApps();
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        const appsContainer = document.getElementById('apps-list');
        if (appsContainer) {
            appsContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶</p>
                    <small>${error.message}</small>
                </div>
            `;
        }
    }
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function displayApps(apps) {
    const appsContainer = document.getElementById('apps-list');
    
    if (!appsContainer) {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± apps-list");
        return;
    }
    
    if (apps.length === 0) {
        appsContainer.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…ØªØ§Ø­Ø©</p></div>';
        return;
    }
    
    appsContainer.innerHTML = apps.map(app => createAppCard(app)).join('');
    console.log("ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:", apps.length);
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©
function displayFeaturedApps() {
    const featuredContainer = document.getElementById('featured-apps');
    
    if (!featuredContainer) {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± featured-apps");
        return;
    }
    
    // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© Ù‡ÙŠ Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ ØªÙ‚ÙŠÙŠÙ… Ø¹Ø§Ù„ÙŠ Ø£Ùˆ marked as featured
    const featuredApps = allApps
        .filter(app => app.featured || (app.rating && app.rating >= 4.0))
        .slice(0, 4);
    
    if (featuredApps.length === 0) {
        featuredContainer.innerHTML = '<div class="empty-state"><i class="fas fa-star"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ù…ÙŠØ²Ø©</p></div>';
        return;
    }
    
    featuredContainer.innerHTML = featuredApps.map(app => createAppCard(app)).join('');
    console.log("ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©:", featuredApps.length);
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
function displayTrendingApps() {
    const trendingContainer = document.getElementById('trending-apps');
    
    if (!trendingContainer) {
        console.error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± trending-apps");
        return;
    }
    
    // Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù‡ÙŠ Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ ØªÙ†Ø²ÙŠÙ„Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø£Ùˆ marked as trending
    const trendingApps = allApps
        .filter(app => app.trending || (app.downloads && app.downloads > 1000))
        .slice(0, 6);
    
    if (trendingApps.length === 0) {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø´Ø§Ø¦Ø¹Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        const randomApps = [...allApps].sort(() => 0.5 - Math.random()).slice(0, 4);
        trendingContainer.innerHTML = randomApps.map(app => createAppCard(app)).join('');
    } else {
        trendingContainer.innerHTML = trendingApps.map(app => createAppCard(app)).join('');
    }
    
    console.log("ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©:", trendingApps.length);
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© ØªØ·Ø¨ÙŠÙ‚
// Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© ØªØ·Ø¨ÙŠÙ‚
function createAppCard(app) {
    const iconClass = getAppIcon(app.category);
    const ratingStars = generateRatingStars(app.rating);
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
    const appIcon = app.iconURL 
        ? `<img src="${app.iconURL}" alt="${app.name}" class="app-icon-img">`
        : `<div class="app-icon"><i class="${iconClass}"></i></div>`;
    
    return `
        <div class="app-card" data-category="${app.category}" data-id="${app.id}">
            <div class="app-header">
                ${appIcon}
                <div class="app-info">
                    <h4>${app.name}</h4>
                    <div class="app-category">${getCategoryName(app.category)}</div>
                </div>
            </div>
            <p class="app-description">${app.description}</p>
            <div class="app-meta">
                <div class="app-version">Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${app.version}</div>
                <div class="app-size">${app.size} MB</div>
            </div>
            <div class="app-meta">
                <div class="app-rating">
                    ${ratingStars}
                    <span>${app.rating || 'ØºÙŠØ± Ù…Ù‚ÙŠÙ…'}</span>
                </div>
                <div class="app-downloads">${app.downloads || 0} ØªÙ†Ø²ÙŠÙ„</div>
            </div>
            ${app.featured ? '<div class="featured-badge">Ù…Ù…ÙŠØ²</div>' : ''}
            ${app.trending ? '<div class="trending-badge">Ø´Ø§Ø¦Ø¹</div>' : ''}
            <div class="app-actions">
                <button class="download-btn" onclick="downloadApp('${app.downloadURL}', '${app.id}')">
                    <i class="fas fa-download"></i>
                    ØªØ­Ù…ÙŠÙ„
                </button>
                ${isAdmin() ? `
                    <button class="delete-btn" onclick="deleteApp('${app.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

// ØªÙˆÙ„ÙŠØ¯ Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
function generateRatingStars(rating) {
    if (!rating) return '<span style="color: var(--text-light);">ØºÙŠØ± Ù…Ù‚ÙŠÙ…</span>';
    
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    
    let stars = '';
    
    // Ù†Ø¬ÙˆÙ… ÙƒØ§Ù…Ù„Ø©
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
    }
    
    // Ù†ØµÙ Ù†Ø¬Ù…Ø©
    if (halfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
    }
    
    // Ù†Ø¬ÙˆÙ… ÙØ§Ø±ØºØ©
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
    }
    
    return stars;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ
function getAppIcon(category) {
    const icons = {
        'games': 'fas fa-gamepad',
        'social': 'fas fa-comments',
        'entertainment': 'fas fa-film',
        'productivity': 'fas fa-briefcase',
        'education': 'fas fa-graduation-cap',
        'utility': 'fas fa-tools'
    };
    return icons[category] || 'fas fa-mobile-alt';
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ
function getCategoryName(category) {
    const categories = {
        'games': 'Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨',
        'social': 'Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ',
        'entertainment': 'Ø§Ù„ØªØ±ÙÙŠÙ‡',
        'productivity': 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©',
        'education': 'Ø§Ù„ØªØ¹Ù„ÙŠÙ…',
        'utility': 'Ø§Ù„Ø£Ø¯ÙˆØ§Øª'
    };
    return categories[category] || category;
}

// ØªØµÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
function filterApps(category) {
    console.log("ØªØµÙÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©:", category);
    
    currentFilter = category;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„ÙØ¦Ø§Øª
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Ø¥Ø¶Ø§ÙØ© active Ù„Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    const activeCategory = document.querySelector(`.category-card[onclick*="${category}"]`);
    if (activeCategory) {
        activeCategory.classList.add('active');
    }
    
    const filteredApps = category === 'all' 
        ? allApps 
        : allApps.filter(app => app.category === category);
    
    displayApps(filteredApps);
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
    document.getElementById('apps-list').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
}

// Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
function searchApps() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    console.log("Ø§Ù„Ø¨Ø¨Ø­Ø« Ø¹Ù†:", searchTerm);
    
    if (!searchTerm) {
        displayApps(allApps);
        return;
    }
    
    const filteredApps = allApps.filter(app => 
        app.name.toLowerCase().includes(searchTerm) ||
        app.description.toLowerCase().includes(searchTerm) ||
        getCategoryName(app.category).toLowerCase().includes(searchTerm)
    );
    
    displayApps(filteredApps);
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const searchModal = document.getElementById('searchModal');
    if (searchModal) {
        searchModal.style.display = 'none';
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const appsContainer = document.getElementById('apps-list');
    if (appsContainer && filteredApps.length > 0) {
        const resultsHeader = document.createElement('div');
        resultsHeader.className = 'search-results-header';
        resultsHeader.innerHTML = `<p>Ø¹Ø±Ø¶ ${filteredApps.length} Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†: "${searchTerm}"</p>`;
        appsContainer.insertBefore(resultsHeader, appsContainer.firstChild);
    }
}

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter)
function performSearch() {
    searchApps();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
function downloadApp(downloadURL, appId) {
    console.log("ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", appId);
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
    const app = allApps.find(app => app.id === appId);
    if (app) {
        app.downloads = (app.downloads || 0) + 1;
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const appCard = document.querySelector(`.app-card[data-id="${appId}"]`);
        if (appCard) {
            const downloadsElement = appCard.querySelector('.app-downloads');
            if (downloadsElement) {
                downloadsElement.textContent = `${app.downloads} ØªÙ†Ø²ÙŠÙ„`;
            }
        }
    }
    
    // ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (downloadURL && downloadURL !== 'https://example.com/app1.zip') {
        window.open(downloadURL, '_blank');
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØªØ¬Ø±ÙŠØ¨ÙŠØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
        alert('Ù‡Ø°Ø§ Ø±Ø§Ø¨Ø· ØªØ¬Ø±ÙŠØ¨ÙŠ. ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„.');
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showTempMessage('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...', 'success');
}

// Ø­Ø°Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø·)
async function deleteApp(appId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) return;
    
    try {
        console.log("Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", appId);
        
        // Ø­Ø°Ù Ù…Ù† Firebase Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø®Ø²Ù†Ø§Ù‹ Ù‡Ù†Ø§Ùƒ
        const app = allApps.find(app => app.id === appId);
        if (app && !sampleApps.some(sample => sample.id === appId)) {
            await deleteDoc(doc(db, "apps", appId));
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        allApps = allApps.filter(app => app.id !== appId);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
        displayApps(allApps);
        displayFeaturedApps();
        displayTrendingApps();
        
        showTempMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", error);
        showTempMessage('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹
function isAdmin() {
    return localStorage.getItem('isAdmin') === 'true';
}

// Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©
function showTempMessage(text, type) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const messageDiv = document.createElement('div');
    messageDiv.className = `temp-message ${type}`;
    messageDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
        <span>${text}</span>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    messageDiv.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        z-index: 3000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    document.body.appendChild(messageDiv);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· CSS Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
const messageStyles = `
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.search-results-header {
    background: var(--primary-light);
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
    text-align: center;
    color: var(--primary);
    font-weight: 500;
    grid-column: 1 / -1;
}

.empty-state, .error-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-secondary);
}

.empty-state i, .error-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--text-light);
}

.error-state i {
    color: #ef4444;
}

.category-card.active {
    border-color: var(--primary);
    background: var(--primary-light);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}
`;

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
const styleSheet = document.createElement('style');
styleSheet.textContent = messageStyles;
document.head.appendChild(styleSheet);

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log("ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø±...");
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª
    loadApps();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¨Ø­Ø«
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
    setupBottomNavigation();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙØ¦Ø§Øª
    setupCategoryEvents();
    
    console.log("ØªÙ… ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„");
});

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
function setupBottomNavigation() {
    const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
    
    bottomNavItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            bottomNavItems.forEach(i => i.classList.remove('active'));
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
            this.classList.add('active');
            
            const target = this.getAttribute('href');
            console.log("Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰:", target);
            
            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            switch(target) {
                case '#games':
                    filterApps('games');
                    break;
                case '#apps':
                    filterApps('all');
                    break;
                case '#search':
                    document.getElementById('searchModal').style.display = 'block';
                    break;
            }
        });
    });
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙØ¦Ø§Øª
function setupCategoryEvents() {
    const categoryCards = document.querySelectorAll('.category-card');
    
    categoryCards.forEach(card => {
        card.addEventListener('click', function() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª
            categoryCards.forEach(c => c.classList.remove('active'));
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            this.classList.add('active');
        });
    });
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© globally
window.filterApps = filterApps;
window.searchApps = searchApps;
window.performSearch = performSearch;
window.downloadApp = downloadApp;
window.deleteApp = deleteApp;

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰
export { loadApps, filterApps, searchApps, downloadApp, deleteApp };


// Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø³Ù†
function initializeImageSystem() {
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    const allImages = document.querySelectorAll('.app-icon img, .category-icon img');
    
    allImages.forEach(img => {
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
        img.addEventListener('error', function() {
            this.style.display = 'none';
            const parent = this.closest('.app-icon, .category-icon');
            if (parent) {
                parent.classList.add('image-error');
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­
        img.addEventListener('load', function() {
            this.style.opacity = '1';
            const parent = this.closest('.app-icon, .category-icon');
            if (parent) {
                parent.classList.remove('image-error');
            }
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„ÙØ§Ø±ØºØ©
        if (!img.src || img.src === '' || img.complete && img.naturalHeight === 0) {
            img.style.display = 'none';
            const parent = img.closest('.app-icon, .category-icon');
            if (parent) {
                parent.classList.add('image-error');
            }
        }
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨ÙƒÙØ§Ø¡Ø©
function loadImagesEfficiently() {
    const imageContainers = document.querySelectorAll('.app-icon, .category-icon');
    
    imageContainers.forEach(container => {
        const img = container.querySelector('img');
        if (img && img.dataset.src) {
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Intersection Observer Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ³ÙˆÙ„
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });
            
            observer.observe(img);
        }
    });
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    initializeImageSystem();
    loadImagesEfficiently();
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                setTimeout(initializeImageSystem, 100);
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
function createFallbackIcon(container, type = 'app') {
    const icon = document.createElement('div');
    icon.className = 'fallback-icon';
    icon.innerHTML = type === 'app' ? 'ğŸ“±' : 'ğŸ“';
    icon.style.cssText = `
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border-radius: inherit;
    `;
    container.appendChild(icon);
}

